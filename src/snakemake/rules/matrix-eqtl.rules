SampleTissue = "Adipose_Subcutaneous"

rule prepare_matrix_eqtl_input:
  params:
    nb_snps = 501,
    covar = SampleTissue + "_Analysis.covariates.txt",
    snp = SampleTissue + "_Analysis.snps.txt",
    expr = SampleTissue + "_Analysis.expr.txt"
  input:
    covar = config["DataDir"] + "/GTEx_Analysis_2015-01-12_eQTLInputFiles_covariates.tar.gz",
    snp = config["DataDir"] + "/GTEx_Analysis_2015-01-12_eQTLInputFiles_snpMatrices.tar.gz",
    genes = config["DataDir"] + "/GTEx_Analysis_2015-01-12_eQTLInputFiles_genePositions.txt",
    expr = config["DataDir"] + "GTEx_Analysis_2015-01-12_eQTLInputFiles_geneLevelNormalizedExpressionMatrices.tar.gz"
  output:
    covar = config["TmpDir"] + "/Covariates.txt",
    snp = config["TmpDir"] + "/SNP.txt",
    snpsloc = config["TmpDir"] + "/snpsloc.txt",
    geneloc = config["TmpDir"] + "/geneloc.txt",
    expr = config["TmpDir"] + "/GE.txt",
    geneloc_bed = config["TmpDir"] + "/geneloc.bed",
    snpsloc_bed = config["TmpDir"] + "/snpsloc.bed",
    gspairs_tmp = temp(config["TmpDir"] + "/gs-pairs.bed")
  shell:
    '''
    # covar
    tar -zxvf {input.covar} {params.covar}
    wc -l {params.covar}
    cut -f1 {params.covar} | tr "\n" ", "
    mv {params.covar} {output.covar}
    # snp / locations for some snps
    tar -zxvf {input.snp} {params.snp} -O | head -{params.nb_snps} > {output.snp}
    echo -e "snp\tchr\tpos" > {output.snpsloc}
    cut {output.snp} -f1 | tail -n+2 | awk -F"_" '{print $0"\t""chr"$1"\t"$2}' >> {output.snpsloc}
    # create @@bedtools@@ input and run @@bedtools@@ to search for genes within 1000bp range to the SNPs of interest.
    tail -n+2 {input.genes} | awk '{print $2"\t"$3"\t"$4+1"\t"$1"\t"1"\t""+"}' > {output.geneloc_bed}
    cut {output.snp} -f1 | tail -n+2 | awk -F"_" '{print $1"\t"$2"\t"$2+1"\t"$0"\t"1"\t""+"}' > {output.snpsloc_bed}
    bedtools closest -a  {output.snpsloc_bed} -b {output.geneloc_bed} |\
    awk '{if (($8-$2)<1000 && ($8-$2)>-1000) print $0}' > {output.gspairs_tmp}
    # Extracted expression data for selected genes
    tar -zxvf {input.expr} {params.expr} -O | head -1 > {output.expr}
    tar -zxvf {input.expr} {params.expr} -O | grep -wf <(cut -f10 {output.gspairs_tmp} | sort -u) >> {output.expr}
    cut -f 1,2 {output.expr}
    # gene location data
    head -1 {input.genes} | cat - <(grep -wf <(cut -f1 {output.expr} | tail -n+2) {input.genes}) > {output.geneloc}
    '''

rule find_genes_with_sumstats:
 input:
   config["TmpDir"] + "/geneloc.txt",
   config["TmpDir"] + "/snpsloc.txt",
   config["InputDir"] + "/{}_Analysis.h5".format(SampleTissue)
 output:
   config["TmpDir"] + "/find_genes_with_sumstats.out"
 run:
   for line in shell("cut -f1 {input[0]} | tail n+2"):
     shell('''python {config[SrcDir]}/python/analysis_admin.py sumstat_query \
     {input[2]} -g {line} -s NULL > {config[TmpDir]}/1.txt''')
     shell('''
        if [[ -s {config[TmpDir]}/1.txt ]]; then
           grep -wf {config[TmpDir]}/1.txt {input[1]} | cut -f1 > {config[TmpDir]}/{line}_snps_to_check.txt
        fi
     ''')

rule eqtlbma_toy:
  workdir: config["TmpDir"]
  params:
    name = "TestTissue"
    prefix = "ToyEQTLBMA"
  input:
    geneloc_bed = config["TmpDir"] + "/geneloc.bed",
    snpsloc_bed = config["TmpDir"] + "/snpsloc.bed",
  output:
    {params.prefix}_sumstats_{params.name}.txt.gz
  shell:
    '''
    echo -e "{params.name}\tSNP.txt.gz" > list_geno.txt
    echo -e "{params.name}\tGE.txt" > list_expl.txt
    echo -e "{params.name}\tCovariates.txt" > list_covar.txt
    {config[bma_bf]} --geno list_geno.txt --exp list_expl.txt --covar list_covar.txt \
           --scoord {input.snpsloc_bed} --gcoord {input.geneloc_bed} \
           --out {params.prefix} --analys join --outss --bfs sin \
           --gridL {config[GridL]} --gridS {config[GridS]} \
           --error uvlr --thread 4
    zcat {output} | head | cut -f1,2,7,9
    '''