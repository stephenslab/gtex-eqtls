import glob

rule sumstat_to_h5:
  input:
    expand("{path}/{tissue}.cis.eqtl.gz", path = config["SSData"], tissue = config["V6Tissues"].split())
  output:
    expand("{path}/{tissue}.h5", path = config["SSData"], tissue = config["V6Tissues"].split())
  log:
    expand("{path}/{tissue}.sumstat_to_h5", path = config["LogDir"], tissue = config["V6Tissues"].split())
  run:
    for x, y, z in zip(input, output, log):
        shell('''python {config[SrcDir]}/python/analysis_admin.py ss_to_h5 \
        {x} --action convert --output {y} --message \
        "MatrixEQTL summary statistics of GTEx Release 2015.04.15" &> {z}''')

rule prepare_merge_batch:
  input:
    config["InputDir"] + "/tss_coords.bed.gz"
  params:
    prefix = config["TmpDir"] + "/tss_coords.bed.split."
  output:
    config["TmpDir"] + "/prepare_merge_batch.out"
  shell:
    "zcat {input} | cut -f4 | split -l 1127 -d - {params.prefix}; "
    "touch {output}"

rule merge_h5:
  input:
    coords = glob.glob(config["TmpDir"] + "/tss_coords.bed.split.*"),
    h5 = glob.glob(config["SSData"] + "/*.h5"),
    link_file = config["TmpDir"] + "/prepare_merge_batch.out"
  params:
    prefix = config["DataDir"] + "/MatrixEQTLSumStats/MatrixEQTLSumStats"
  output:
    config["DataDir"] + "/MatrixEQTLSumStats.h5"
  run:
    for idx, item in enumerate(input.coords):
        shell('''python {config[SrcDir]}/python/analysis_admin.py ss_to_h5 \
        {input.h5} --action merge --output {params.prefix}.{idx} \
        --message "MatrixEQTL summary statistics of GTEx Release 2015.04.15" \
        --gene-list {item}''')
    shell('''python {config[SrcDir]}/python/analysis_admin.py ss_to_h5 \
    {params.prefix}.*.h5 --action cat --output {output}''')

rule sample_max_null:
  input:
    data = config["DataDir"] + "/MatrixEQTLSumStats.h5",
    genes = config["DBDir"] + "/snp-gene-pairs/GTExV6Genes.gz"
  output:
    config["DataDir"] + "/MatrixEQTLSumStats.Portable.h5"
  shell:
    '''python {config[SrcDir]}/python/analysis_admin.py ss_to_h5 \
    {input.data} --action max --output {output};'''
    '''python {config[SrcDir]}/python/analysis_admin.py ss_to_h5 \
    {input.data} --action null --output {output} --gene-list <(zcat {input.genes})'''